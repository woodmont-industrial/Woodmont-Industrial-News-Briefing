name: Update RSS Feed

on:
  schedule:
      - cron: '*/30 13-23 * * 1-5'
          - cron: '*/30 0-1 * * 2-6'
            workflow_dispatch:

            permissions:
              contents: write

              jobs:
                update-feed:
                    runs-on: ubuntu-latest
                        timeout-minutes: 15

                            steps:
                                  - name: Checkout repository
                                          uses: actions/checkout@v4
                                                  with:
                                                            fetch-depth: 0

                                                                  - name: Setup Node.js
                                                                          uses: actions/setup-node@v4
                                                                                  with:
                                                                                            node-version: '20'

                                                                                                  - name: Install dependencies
                                                                                                          run: npm install --prefer-offline --no-audit
                                                                                                          
                                                                                                                - name: Fetch RSS feeds and build static files
                                                                                                                        run: |
                                                                                                                                  echo "ðŸ“° Fetching RSS feeds..."
                                                                                                                                            npm run build-static || true
                                                                                                                                                      echo "âœ… Build step completed"
                                                                                                                                                              env:
                                                                                                                                                                        NODE_ENV: production
                                                                                                                                                                                timeout-minutes: 10
                                                                                                                                                                                        continue-on-error: true
                                                                                                                                                                                        
                                                                                                                                                                                              - name: Verify build output
                                                                                                                                                                                                      run: |
                                                                                                                                                                                                                if [ -f "docs/rss.xml" ]; then
                                                                                                                                                                                                                            echo "âœ… rss.xml exists"
                                                                                                                                                                                                                                        FILE_SIZE=$(wc -c < docs/rss.xml)
                                                                                                                                                                                                                                                    echo "ðŸ“Š File size: $FILE_SIZE bytes"
                                                                                                                                                                                                                                                                if [ "$FILE_SIZE" -lt 500 ]; then
                                                                                                                                                                                                                                                                              echo "âš ï¸ Warning: rss.xml seems too small"
                                                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                                                    else
                                                                                                                                                                                                                                                                                                                echo "âš ï¸ rss.xml not found - keeping existing feed"
                                                                                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                    if [ -f "docs/feed.json" ]; then
                                                                                                                                                                                                                                                                                                                                                echo "âœ… feed.json exists"
                                                                                                                                                                                                                                                                                                                                                          fi
                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                - name: Commit and push changes
                                                                                                                                                                                                                                                                                                                                                                        run: |
                                                                                                                                                                                                                                                                                                                                                                                  git pull --rebase origin main
                                                                                                                                                                                                                                                                                                                                                                                            git config --local user.email "github-actions[bot]@users.noreply.github.com"
                                                                                                                                                                                                                                                                                                                                                                                                      git config --local user.name "github-actions[bot]"
                                                                                                                                                                                                                                                                                                                                                                                                                git add docs/
                                                                                                                                                                                                                                                                                                                                                                                                                          if git diff --staged --quiet; then
                                                                                                                                                                                                                                                                                                                                                                                                                                      echo "ðŸ“‹ No changes to commit"
                                                                                                                                                                                                                                                                                                                                                                                                                                                else
                                                                                                                                                                                                                                                                                                                                                                                                                                                            git commit -m "ðŸ”„ Update RSS feed [$(date -u +'%Y-%m-%d %H:%M UTC')]"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        git push
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    echo "âœ… Changes pushed"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              fi
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    - name: Report Success
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            if: success()
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    run: |
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              echo "::notice::RSS feed updated successfully!"
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        echo "ðŸ“Š Feed URL: https://prcasley.github.io/Woodmont-Industrial-News-Briefing/rss.xml"
