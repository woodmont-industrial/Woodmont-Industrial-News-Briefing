<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Raw Articles — Woodmont Industrial</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>tailwind.config = { darkMode: 'class' }</script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7.23.5/babel.min.js"></script>
  <style>
    body {
      background: linear-gradient(135deg, #064e3b 0%, #047857 50%, #10b981 100%);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      min-height: 100vh;
    }
    .dark { background-color: #0f172a; color: #f1f5f9; }
    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white !important;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 25px 80px rgba(0,0,0,0.25), 0 10px 30px rgba(0,0,0,0.15);
    }
    .dark .container { background: #1e293b !important; }
    .row-hover { transition: background 150ms ease; }
    .row-hover:hover { background: #f0fdf4 !important; }
    .dark .row-hover:hover { background: #334155 !important; }
  </style>
</head>
<body>
<div id="root"></div>
<script src="js/utils.js"></script>
<script type="text/babel">
const { useState, useEffect, useMemo, useCallback } = React;

const RAW_FEED_URL = './raw-feed.json';
const PREFS_KEY = 'woodmont_ai_preferences';

// Server-backed picks via WoodmontUtils
const { getUserId, loadServerPreferences, getRawPicks, setAllRawPicks, clearRawPicks } = window.WoodmontUtils;

function loadPrefs() {
  try { return JSON.parse(localStorage.getItem(PREFS_KEY) || '{"sources":{},"categories":{},"regions":{},"keywords":{}}'); }
  catch { return { sources: {}, categories: {}, regions: {}, keywords: {} }; }
}
function savePrefs(prefs) { localStorage.setItem(PREFS_KEY, JSON.stringify(prefs)); }

function updatePrefs(article, prefs) {
  const bump = (map, key) => { if (key) map[key] = (map[key] || 0) + 1; };
  bump(prefs.sources, article.s);
  bump(prefs.categories, article.c);
  bump(prefs.regions, article.r);
  (article.kw || []).forEach(k => bump(prefs.keywords, k));
  return prefs;
}

function removePrefs(article, prefs) {
  const dec = (map, key) => { if (key && map[key]) { map[key]--; if (map[key] <= 0) delete map[key]; } };
  dec(prefs.sources, article.s);
  dec(prefs.categories, article.c);
  dec(prefs.regions, article.r);
  (article.kw || []).forEach(k => dec(prefs.keywords, k));
  return prefs;
}

// ── AI score ──
function computeAIScore(article, prefs) {
  const maxOf = (map) => Math.max(1, ...Object.values(map).map(Number));
  const norm = (map, key) => key && map[key] ? map[key] / maxOf(map) : 0;
  const sourceW = 0.3, kwW = 0.3, catW = 0.2, regW = 0.2;
  const kwScore = article.kw && article.kw.length > 0
    ? article.kw.reduce((s, k) => s + norm(prefs.keywords, k), 0) / article.kw.length : 0;
  return Math.round((
    norm(prefs.sources, article.s) * sourceW +
    kwScore * kwW +
    norm(prefs.categories, article.c) * catW +
    norm(prefs.regions, article.r) * regW
  ) * 100);
}

function topPrefs(prefs) {
  const top = (map, n = 3) => Object.entries(map).sort((a, b) => b[1] - a[1]).slice(0, n).map(e => e[0]);
  const items = [...top(prefs.keywords), ...top(prefs.sources, 2), ...top(prefs.regions, 2)];
  return [...new Set(items)].slice(0, 6);
}

function timeAgo(dateStr) {
  if (!dateStr) return '';
  const ms = Date.now() - new Date(dateStr).getTime();
  const h = Math.floor(ms / 3600000);
  if (h < 1) return `${Math.floor(ms / 60000)}m ago`;
  if (h < 24) return `${h}h ago`;
  return `${Math.floor(h / 24)}d ago`;
}

// ── Category badge colors ──
const CAT_COLORS = {
  relevant: 'bg-emerald-100 text-emerald-800 dark:bg-emerald-900 dark:text-emerald-200',
  transactions: 'bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200',
  people: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200',
  availabilities: 'bg-amber-100 text-amber-800 dark:bg-amber-900 dark:text-amber-200',
  excluded: 'bg-red-100 text-red-700 dark:bg-red-900 dark:text-red-300',
};

// ── Main App ──
function RawApp() {
  const [items, setItems] = useState([]);
  const [stats, setStats] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [picks, setPicks] = useState(() => getRawPicks());
  const [prefs, setPrefs] = useState(loadPrefs);
  const [dark, setDark] = useState(() => localStorage.getItem('woodmont_theme') === 'dark');
  const [currentUser, setCurrentUser] = useState(() => getUserId());

  // Filters
  const [search, setSearch] = useState('');
  const [sourceFilter, setSourceFilter] = useState('all');
  const [catFilter, setCatFilter] = useState('all');
  const [regionFilter, setRegionFilter] = useState('all');
  const [sortBy, setSortBy] = useState(() => {
    const p = loadPrefs();
    return Object.keys(p.keywords).length > 0 ? 'ai' : 'newest';
  });
  const [hideInFeed, setHideInFeed] = useState(false);
  const [hidePicked, setHidePicked] = useState(true);
  const [expandedId, setExpandedId] = useState(null);
  const [syncStatus, setSyncStatus] = useState(null); // null | 'syncing' | 'synced' | 'failed'

  // Dark mode
  useEffect(() => {
    document.documentElement.classList.toggle('dark', dark);
    localStorage.setItem('woodmont_theme', dark ? 'dark' : 'light');
  }, [dark]);

  // Load server preferences, then fetch raw feed
  useEffect(() => {
    const init = async () => {
      const userId = getUserId();
      if (userId) {
        await loadServerPreferences(userId);
        setPicks(getRawPicks());
        setCurrentUser(userId);
      }
      setLoading(true);
      try {
        const r = await fetch(RAW_FEED_URL);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const data = await r.json();
        setItems(data.items || []);
        setStats(data.stats || null);
      } catch (e) {
        setError(e.message);
      } finally {
        setLoading(false);
      }
    };
    init();
  }, []);

  // Unique values for filter dropdowns
  const sources = useMemo(() => [...new Set(items.map(i => i.s))].sort(), [items]);
  const categories = useMemo(() => [...new Set(items.map(i => i.c))].filter(Boolean).sort(), [items]);
  const regions = useMemo(() => [...new Set(items.map(i => i.r))].filter(Boolean).sort(), [items]);

  // Filtered + sorted list
  const filtered = useMemo(() => {
    const q = search.toLowerCase();
    let list = items.filter(i => {
      if (hidePicked && picks[i.id]) return false;
      if (hideInFeed && i.in_feed) return false;
      if (sourceFilter !== 'all' && i.s !== sourceFilter) return false;
      if (catFilter !== 'all' && i.c !== catFilter) return false;
      if (regionFilter !== 'all' && i.r !== regionFilter) return false;
      if (q && !(i.t || '').toLowerCase().includes(q) && !(i.s || '').toLowerCase().includes(q)
          && !(i.ex || '').toLowerCase().includes(q)) return false;
      return true;
    });
    if (sortBy === 'ai') {
      list = list.map(i => ({ ...i, _score: computeAIScore(i, prefs) }))
                 .sort((a, b) => b._score - a._score || new Date(b.d) - new Date(a.d));
    } else if (sortBy === 'oldest') {
      list.sort((a, b) => new Date(a.d) - new Date(b.d));
    } else {
      list.sort((a, b) => new Date(b.d) - new Date(a.d));
    }
    return list;
  }, [items, search, sourceFilter, catFilter, regionFilter, sortBy, hideInFeed, hidePicked, picks, prefs]);

  const pickCount = Object.keys(picks).length;
  const prefTags = useMemo(() => topPrefs(prefs), [prefs]);

  const togglePick = useCallback((article) => {
    setPicks(prev => {
      const next = { ...prev };
      let newPrefs = { ...prefs };
      const wasRemoved = !!next[article.id];
      if (wasRemoved) {
        delete next[article.id];
        newPrefs = removePrefs(article, newPrefs);
      } else {
        next[article.id] = { t: article.t, u: article.u, s: article.s, d: article.d, ex: article.ex, c: article.c, r: article.r, kw: article.kw };
        newPrefs = updatePrefs(article, newPrefs);
      }
      setAllRawPicks(next);
      setPrefs(newPrefs);
      savePrefs(newPrefs);
      // Fire-and-forget GitHub sync
      if (window.WoodmontUtils && window.WoodmontUtils.getGitHubToken()) {
        setSyncStatus('syncing');
        const syncFn = wasRemoved
          ? window.WoodmontUtils.removeIncludeFromGitHub(article.id)
          : window.WoodmontUtils.syncIncludeToGitHub(article.id, next[article.id]);
        syncFn.then(r => { setSyncStatus(r.ok ? 'synced' : 'failed'); setTimeout(() => setSyncStatus(null), 2000); })
              .catch(() => { setSyncStatus('failed'); setTimeout(() => setSyncStatus(null), 2000); });
      }
      return next;
    });
  }, [prefs]);

  const clearPicks = useCallback(() => {
    setPicks({});
    clearRawPicks();
    if (window.WoodmontUtils && window.WoodmontUtils.getGitHubToken()) {
      setSyncStatus('syncing');
      window.WoodmontUtils.clearIncludesOnGitHub()
        .then(r => { setSyncStatus(r.ok ? 'synced' : 'failed'); setTimeout(() => setSyncStatus(null), 2000); })
        .catch(() => { setSyncStatus('failed'); setTimeout(() => setSyncStatus(null), 2000); });
    }
  }, []);

  const selectAll = useCallback(() => {
    const newPicks = { ...picks };
    const newlyAdded = {};
    let newPrefs = { ...prefs };
    filtered.forEach(item => {
      if (!newPicks[item.id]) {
        const pickData = { t: item.t, u: item.u, s: item.s, d: item.d, ex: item.ex, c: item.c, r: item.r, kw: item.kw };
        newPicks[item.id] = pickData;
        newlyAdded[item.id] = pickData;
        newPrefs = updatePrefs(item, newPrefs);
      }
    });
    setPicks(newPicks);
    setAllRawPicks(newPicks);
    setPrefs(newPrefs);
    savePrefs(newPrefs);
    if (Object.keys(newlyAdded).length > 0 && window.WoodmontUtils && window.WoodmontUtils.getGitHubToken()) {
      setSyncStatus('syncing');
      window.WoodmontUtils.syncMultipleIncludesToGitHub(newlyAdded)
        .then(r => { setSyncStatus(r.ok ? 'synced' : 'failed'); setTimeout(() => setSyncStatus(null), 2000); })
        .catch(() => { setSyncStatus('failed'); setTimeout(() => setSyncStatus(null), 2000); });
    }
  }, [filtered, picks, prefs]);

  if (loading) return (
    <div className="container p-12 text-center">
      <div className="animate-spin w-8 h-8 border-4 border-emerald-500 border-t-transparent rounded-full mx-auto mb-4"></div>
      <p className="text-slate-600 dark:text-slate-400">Loading raw articles...</p>
    </div>
  );
  if (error) return (
    <div className="container p-12 text-center">
      <p className="text-red-600">Unable to load raw articles</p>
      <p className="text-sm text-slate-500 mt-2">The raw article feed is temporarily unavailable. Please try again later.</p>
    </div>
  );

  return (
    <div className="container">
      {/* ── Nav Bar ── */}
      <div className="bg-gradient-to-r from-emerald-700 to-emerald-600 dark:from-slate-800 dark:to-slate-700 px-6 py-4 flex items-center justify-between">
        <div className="flex items-center gap-3">
          <span className="text-2xl font-bold text-white tracking-tight">Woodmont Industrial</span>
          <span className="text-emerald-200 dark:text-slate-400 text-sm hidden sm:inline">Raw Article Feed</span>
          {currentUser && (
            <span className="px-3 py-1 bg-white/20 text-white rounded-full text-xs font-medium">
              {currentUser}
            </span>
          )}
        </div>
        <div className="flex items-center gap-2">
          <a href="./" className="px-4 py-2 rounded-xl font-medium text-sm bg-white/20 text-white hover:bg-white/30 transition no-underline">Articles</a>
          <span className="px-4 py-2 rounded-xl font-medium text-sm bg-orange-500 text-white">Raw</span>
          <a href="./index.html" onClick={(e) => { e.preventDefault(); window.location.href = './index.html'; setTimeout(() => { /* newsletter view via hash not available in static split */ }, 100); }}
             className="px-4 py-2 rounded-xl font-medium text-sm bg-white/20 text-white hover:bg-white/30 transition no-underline">Newsletter</a>
          <button onClick={() => setDark(d => !d)} className="ml-2 px-3 py-2 rounded-xl bg-white/20 text-white hover:bg-white/30 transition text-sm">
            {dark ? 'Light' : 'Dark'}
          </button>
        </div>
      </div>

      {/* ── Stats Bar ── */}
      <div className="px-6 py-3 bg-slate-50 dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex flex-wrap items-center gap-4 text-sm">
        <span className="font-semibold text-slate-700 dark:text-slate-200">
          {filtered.length} article{filtered.length !== 1 ? 's' : ''}
          {stats && <span className="font-normal text-slate-500 dark:text-slate-400"> from {stats.total_fetched} fetched ({stats.window_hours}h window)</span>}
        </span>
        {stats && (
          <span className="text-emerald-600 dark:text-emerald-400 font-medium">{stats.included_in_feed} in curated feed</span>
        )}
        {prefTags.length > 0 && (
          <div className="flex items-center gap-1 ml-auto">
            <span className="text-slate-500 dark:text-slate-400 text-xs">AI prefs:</span>
            {prefTags.map(tag => (
              <span key={tag} className="px-2 py-0.5 bg-orange-100 dark:bg-orange-900 text-orange-700 dark:text-orange-300 rounded-full text-xs">{tag}</span>
            ))}
          </div>
        )}
      </div>

      {/* ── Filter Bar ── */}
      <div className="px-6 py-3 bg-white dark:bg-slate-800 border-b border-slate-200 dark:border-slate-700 flex flex-wrap items-center gap-3">
        <input
          type="text"
          placeholder="Search articles..."
          value={search}
          onChange={e => setSearch(e.target.value)}
          className="flex-1 min-w-[200px] rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-emerald-300 dark:focus:ring-emerald-600 text-slate-900 dark:text-white"
        />
        <select value={sourceFilter} onChange={e => setSourceFilter(e.target.value)}
          className="rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm outline-none text-slate-900 dark:text-white">
          <option value="all">All Sources</option>
          {sources.map(s => <option key={s} value={s}>{s}</option>)}
        </select>
        <select value={catFilter} onChange={e => setCatFilter(e.target.value)}
          className="rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm outline-none text-slate-900 dark:text-white">
          <option value="all">All Categories</option>
          {categories.map(c => <option key={c} value={c}>{c}</option>)}
        </select>
        <select value={regionFilter} onChange={e => setRegionFilter(e.target.value)}
          className="rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm outline-none text-slate-900 dark:text-white">
          <option value="all">All Regions</option>
          {regions.map(r => <option key={r} value={r}>{r}</option>)}
        </select>
        <select value={sortBy} onChange={e => setSortBy(e.target.value)}
          className="rounded-lg border border-slate-200 dark:border-slate-600 bg-white dark:bg-slate-700 px-3 py-2 text-sm outline-none text-slate-900 dark:text-white">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="ai">AI Score</option>
        </select>
        <label className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 cursor-pointer whitespace-nowrap">
          <input type="checkbox" checked={hidePicked} onChange={e => setHidePicked(e.target.checked)}
            className="rounded border-slate-300 text-orange-500 focus:ring-orange-300" />
          Hide picked
        </label>
        <label className="flex items-center gap-2 text-sm text-slate-600 dark:text-slate-400 cursor-pointer whitespace-nowrap">
          <input type="checkbox" checked={hideInFeed} onChange={e => setHideInFeed(e.target.checked)}
            className="rounded border-slate-300 text-emerald-500 focus:ring-emerald-300" />
          Hide in-feed
        </label>
      </div>

      {/* ── Article List ── */}
      <div className="overflow-auto" style={{ maxHeight: 'calc(100vh - 320px)' }}>
        <table className="w-full text-sm">
          <thead className="sticky top-0 bg-slate-100 dark:bg-slate-700 z-10">
            <tr className="text-left text-xs uppercase text-slate-500 dark:text-slate-400">
              <th className="py-2 px-3 w-10">
                <button onClick={selectAll} title="Select all visible" className="text-emerald-600 dark:text-emerald-400 hover:underline text-xs">All</button>
              </th>
              <th className="py-2 px-3">Title</th>
              <th className="py-2 px-3 w-36">Source</th>
              <th className="py-2 px-3 w-24">Time</th>
              <th className="py-2 px-3 w-28">Category</th>
              <th className="py-2 px-3 w-16">Region</th>
              {sortBy === 'ai' && <th className="py-2 px-3 w-16 text-right">Score</th>}
              <th className="py-2 px-3 w-16 text-center">Feed</th>
            </tr>
          </thead>
          <tbody>
            {filtered.length === 0 && (
              <tr><td colSpan={sortBy === 'ai' ? 8 : 7} className="text-center py-12 text-slate-400">No articles match filters</td></tr>
            )}
            {filtered.map(item => {
              const picked = !!picks[item.id];
              const expanded = expandedId === item.id;
              return (
                <React.Fragment key={item.id}>
                  <tr
                    className={`row-hover border-b border-slate-100 dark:border-slate-700 cursor-pointer ${picked ? 'bg-orange-50 dark:bg-orange-950' : ''}`}
                    onClick={() => setExpandedId(expanded ? null : item.id)}
                  >
                    <td className="py-2 px-3" onClick={e => e.stopPropagation()}>
                      <input type="checkbox" checked={picked} onChange={() => togglePick(item)}
                        className="rounded border-slate-300 text-orange-500 focus:ring-orange-300 cursor-pointer" />
                    </td>
                    <td className="py-2 px-3">
                      <span className={`font-medium ${picked ? 'text-orange-700 dark:text-orange-300' : 'text-slate-800 dark:text-slate-200'}`}>
                        {item.t || 'Untitled'}
                      </span>
                    </td>
                    <td className="py-2 px-3 text-slate-500 dark:text-slate-400 truncate max-w-[140px]">{item.s}</td>
                    <td className="py-2 px-3 text-slate-400 dark:text-slate-500 whitespace-nowrap">{timeAgo(item.d)}</td>
                    <td className="py-2 px-3">
                      <span className={`px-2 py-0.5 rounded-full text-xs font-medium ${CAT_COLORS[item.c] || 'bg-slate-100 text-slate-600 dark:bg-slate-700 dark:text-slate-300'}`}>
                        {item.c || 'unknown'}
                      </span>
                    </td>
                    <td className="py-2 px-3 text-slate-500 dark:text-slate-400 text-xs">{item.r || '-'}</td>
                    {sortBy === 'ai' && (
                      <td className="py-2 px-3 text-right">
                        <span className={`font-mono text-xs font-bold ${item._score >= 50 ? 'text-emerald-600' : item._score >= 20 ? 'text-amber-600' : 'text-slate-400'}`}>
                          {item._score || 0}
                        </span>
                      </td>
                    )}
                    <td className="py-2 px-3 text-center">
                      {item.in_feed && <span className="text-emerald-500" title="In curated feed">&#10003;</span>}
                    </td>
                  </tr>
                  {expanded && (
                    <tr className="bg-slate-50 dark:bg-slate-800">
                      <td colSpan={sortBy === 'ai' ? 8 : 7} className="px-6 py-3">
                        <div className="flex flex-col gap-2">
                          {item.ex && <p className="text-sm text-slate-600 dark:text-slate-300">{item.ex}</p>}
                          {item.kw && item.kw.length > 0 && (
                            <div className="flex gap-1 flex-wrap">
                              {item.kw.map(k => <span key={k} className="px-2 py-0.5 bg-slate-200 dark:bg-slate-600 text-slate-700 dark:text-slate-300 rounded text-xs">{k}</span>)}
                            </div>
                          )}
                          <div className="flex gap-3 mt-1">
                            <a href={item.u} target="_blank" rel="noopener noreferrer" className="text-blue-600 dark:text-blue-400 hover:underline text-xs">
                              Open article &rarr;
                            </a>
                            <button onClick={() => togglePick(item)} className={`text-xs font-medium ${picked ? 'text-red-600' : 'text-orange-600'}`}>
                              {picked ? '\u2190 Back to Raw' : 'Pick for newsletter'}
                            </button>
                          </div>
                        </div>
                      </td>
                    </tr>
                  )}
                </React.Fragment>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* ── Sticky Bottom Bar ── */}
      <div className="sticky bottom-0 bg-white dark:bg-slate-800 border-t border-slate-200 dark:border-slate-700 px-6 py-3 flex items-center justify-between shadow-[0_-4px_12px_rgba(0,0,0,0.08)]">
        <div className="flex items-center gap-3">
          <span className={`font-semibold ${pickCount > 0 ? 'text-orange-600 dark:text-orange-400' : 'text-slate-400'}`}>
            {pickCount} picked
          </span>
          {pickCount > 0 && (
            <button onClick={clearPicks} className="text-xs text-red-500 hover:underline">Clear all</button>
          )}
        </div>
        <div className="flex items-center gap-3">
          {pickCount > 0 && (
            <a href="./index.html" className="px-4 py-2 bg-emerald-500 text-white rounded-lg font-medium hover:bg-emerald-600 transition text-sm no-underline">
              Go to Newsletter ({pickCount} picks ready)
            </a>
          )}
          {syncStatus && (
            <span className={`text-xs font-medium ${syncStatus === 'syncing' ? 'text-blue-500' : syncStatus === 'synced' ? 'text-emerald-500' : 'text-red-500'}`}>
              {syncStatus === 'syncing' ? 'Syncing...' : syncStatus === 'synced' ? 'Synced!' : 'Sync failed'}
            </span>
          )}
          <span className="text-xs text-slate-400 dark:text-slate-500">
            {currentUser ? `Picks synced for ${currentUser}` : 'Picks saved to browser'} &bull; AI learns your preferences
          </span>
        </div>
      </div>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById('root')).render(<RawApp />);
</script>
</body>
</html>
